#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
maro 채널 오늘의 위로 콘텐츠 생성기
3분 위로 콘텐츠 세부 구성안 적용
"""

import random
from typing import List, Dict
from openai import OpenAI
from config import OPENAI_API_KEY, OPENAI_TEXT_MODEL

client = OpenAI(api_key=OPENAI_API_KEY)

class ComfortContentGenerator:
    """maro 채널용 위로 콘텐츠 생성기 - 세부 기획안 적용"""

    def __init__(self):
        self.client = client
        
    def generate_daily_comfort(self, theme: str = None) -> Dict:
        """오늘의 위로 (Daily Comfort) - 습관형 루틴 콘텐츠 (3분)"""
        if not theme:
            themes = [
                # 기본 위로 테마
                "일상의 작은 기쁨", "힘든 순간을 이겨내는 법", 
                "자신을 사랑하는 방법", "새로운 시작의 용기",
                "외로움을 극복하는 법", "스트레스 해소법",
                "자신감을 키우는 방법", "감사함을 느끼는 법",
                
                # 자존감 향상 테마
                "자존감을 높이는 방법", "자신의 가치를 알아보는 법",
                "비교하지 않고 자신을 사랑하는 법", "완벽주의를 버리는 법",
                "자신의 강점을 발견하는 법", "자신을 용서하는 법",
                "자신의 감정을 인정하는 법", "자신의 한계를 받아들이는 법",
                
                # 일상적 어려움 극복 테마
                "실패 후 다시 일어서는 법", "변화에 적응하는 법",
                "불안감을 다루는 법", "우울한 기분을 이겨내는 법",
                "스트레스로 인한 피로를 회복하는 법", "새로운 환경에서 견뎌내는 법",
                "인간관계의 어려움을 해결하는 법", "목표 달성에 실패했을 때 대처법",
                
                # 마음의 평화 찾기 테마
                "마음의 평화를 찾는 법", "현재 순간에 집중하는 법",
                "과거의 상처를 치유하는 법", "미래에 대한 걱정을 줄이는 법",
                "자신의 감정을 조절하는 법", "마음의 소리에 귀 기울이는 법",
                "자신만의 안전한 공간을 만드는 법", "마음의 상처를 스스로 치료하는 법",
                
                # 성장과 발전 테마
                "자신의 꿈을 향해 나아가는 법", "작은 성취를 축하하는 법",
                "자신의 한계를 넓히는 법", "새로운 도전을 두려워하지 않는 법",
                "자신의 열정을 찾는 법", "자신의 재능을 개발하는 법",
                "자신의 가치관을 정립하는 법", "자신의 인생을 설계하는 법",
                
                # 관계와 소통 테마
                "자신을 이해하는 사람을 만나는 법", "건강한 경계선을 설정하는 법",
                "자신의 감정을 솔직하게 표현하는 법", "다른 사람의 말에 귀 기울이는 법",
                "자신의 의견을 자신 있게 말하는 법", "갈등을 건설적으로 해결하는 법",
                "자신의 감정을 조절하는 법", "건강한 인간관계를 만드는 법",
                
                # 일과 삶의 균형 테마
                "업무 스트레스를 관리하는 법", "일과 휴식의 균형을 찾는 법",
                "자신의 시간을 소중히 여기는 법", "일상의 소소한 즐거움을 찾는 법",
                "자신의 에너지를 관리하는 법", "자신의 가치에 맞는 일을 찾는 법",
                "일과 가족의 균형을 맞추는 법", "자신의 열정을 일과 연결하는 법",
                
                # 건강과 웰빙 테마
                "마음의 건강을 지키는 법", "신체적 건강을 관리하는 법",
                "충분한 휴식을 취하는 법", "자신의 몸을 사랑하는 법",
                "건강한 습관을 만드는 법", "자신의 에너지 수준을 파악하는 법",
                "스트레스 해소를 위한 운동법", "마음의 평화를 위한 명상법"
            ]
            theme = random.choice(themes)
        
        # 3분 위로 콘텐츠 전용 구조화된 프롬프트
        prompt = f"""
        다음 주제로 "3분 위로 콘텐츠"를 작성해주세요.
        주제: {theme}
        
        **3분 위로 콘텐츠 세부 구성안**
        
        1. 전체 시간 배분 (3분 = 180초)
        - 인트로 (10~15초): 채널 아이덴티티 + 주제 소개
        - 본문 위로글 (120~130초, 약 2분): 이어지는 위로 글귀 낭독
        - 클로징 멘트 (20~30초): 요약 + 다음 영상 안내
        
        2. 본문 위로글 구성 (2분 분량)
        - 공감 → 감정 이해 → 위로 메시지 → 희망 제시 순서로 구성
        - 6~8개의 짧은 단락으로 이어지는 글 (편지, 명상문 형태)
        - 한 문장이 5~8초 정도 읽히도록 구성
        - 문장 끝마다 1~2초 멈춤으로 여운 강조
        
        3. 글의 흐름 예시
        - 공감: "오늘도 지치셨죠."
        - 감정 이해: "때로는 결과가 없어도 의미가 있습니다."
        - 위로 메시지: "잠시 멈춰도 괜찮습니다."
        - 희망 제시: "내일도 당신을 기다리는 빛이 있습니다."
        
        4. 요구사항
        - 따뜻하고 공감되는 톤으로 작성
        - 구체적인 예시나 상황 포함
        - 실용적인 조언이나 격려 포함
        - 3분 분량 (약 400-500자)
        - 마지막에 희망적인 메시지로 마무리
        - 시청자가 실제로 적용할 수 있는 구체적인 방법 제시
        - 자신감과 용기를 줄 수 있는 내용으로 구성
        - 습관화 효과를 위한 반복 가능한 구조
        - 하루를 시작하거나 마무리할 수 있는 위로
        """
        
        try:
            response = self.client.chat.completions.create(
                model=OPENAI_TEXT_MODEL,
                messages=[{"role": "user", "content": prompt}],
                max_tokens=600,
                temperature=0.8
            )
            
            content = response.choices[0].message.content
            
            # 구조화된 콘텐츠 반환 (3분 세부 구성안 포함)
            return {
                "type": "daily_comfort",
                "theme": theme,
                "title": f"오늘의 위로: {theme}",
                "content": content,
                "duration": "3분",
                "tags": ["위로", "힐링", "일상위로", "maro", "마음위로", "자존감", "자기계발", "루틴"],
                "structure": {
                    "intro": "10-15초 - 채널 로고 + '오늘의 위로' 타이틀 + 주제 소개",
                    "main_message": "120-130초 - 이어지는 위로 글귀 낭독 (6-8개 단락)",
                    "outro": "20-30초 - 요약 + '당신은 혼자가 아닙니다' + 다음 영상 안내"
                },
                "timing": {
                    "0:00-0:15": "인트로 - 로고 + 제목 카드 + 주제 소개",
                    "0:15-2:25": "본문 위로글 - 6-8개 단락으로 이어지는 글귀 낭독",
                    "2:25-3:00": "아웃로 - 요약 + 구독/다음 영상 안내"
                },
                "visual_elements": [
                    "고정샷: 하늘, 숲길, 파도, 창밖 풍경",
                    "미니멀 애니메이션: 별빛, 꽃잎, 파도 라인",
                    "자막: 낭독 글귀를 그대로 표시 (화면 중앙/하단)",
                    "폰트: 둥근고딕, 산세리프 계열 (가독성 중심)",
                    "컬러: 따뜻한 파스텔 톤 (노을빛, 크림색, 푸른빛)"
                ],
                "audio_elements": [
                    "BGM: 피아노/스트링/어쿠스틱 기타 중심, 잔잔하고 단순한 멜로디",
                    "내레이션: 느리고 차분한 톤, 문장 끝마다 1-2초 멈춤",
                    "볼륨: 글귀 낭독 시 낮게, 멘트 사이 공백에 살짝 올려 여운 강조"
                ],
                "content_structure": {
                    "flow": "공감 → 감정 이해 → 위로 메시지 → 희망 제시",
                    "paragraphs": "6-8개 짧은 단락으로 구성",
                    "sentence_timing": "한 문장 5-8초, 문장 끝마다 1-2초 멈춤",
                    "style": "편지, 명상문 형태의 이어지는 글"
                }
            }
        except Exception as e:
            print(f"콘텐츠 생성 오류: {e}")
            return self._get_fallback_comfort(theme)

    def _get_fallback_comfort(self, theme: str) -> Dict:
        """기본 위로 콘텐츠 (API 오류 시) - 3분 구성안 포함"""
        fallback_contents = {
            "일상의 작은 기쁨": "오늘 하루도 잘 버텨줘서 고마워요. 작은 것 하나라도 감사함을 느껴보세요.",
            "힘든 순간을 이겨내는 법": "힘든 순간은 지나갑니다. 당신은 이미 충분히 강합니다.",
            "자신을 사랑하는 방법": "완벽하지 않아도 괜찮아요. 당신은 그 자체로 소중합니다.",
            "자존감을 높이는 방법": "자신의 장점을 하나씩 적어보세요. 당신은 생각보다 훨씬 훌륭합니다.",
            "자신의 가치를 알아보는 법": "다른 사람의 기준이 아닌, 자신만의 기준으로 자신을 평가해보세요.",
            "비교하지 않고 자신을 사랑하는 법": "비교는 불행의 시작입니다. 당신만의 독특한 아름다움이 있어요.",
            "완벽주의를 버리는 법": "완벽함보다는 진실함이 더 아름답습니다. 실수해도 괜찮아요.",
            "자신의 강점을 발견하는 법": "당신이 잘하는 일을 찾아보세요. 그것이 당신의 진정한 재능입니다."
        }
        
        content = fallback_contents.get(theme, "오늘 하루도 수고했어요. 내일은 더 좋은 하루가 될 거예요.")
        
        return {
            "type": "daily_comfort",
            "theme": theme,
            "title": f"오늘의 위로: {theme}",
            "content": content,
            "duration": "3분",
            "tags": ["위로", "힐링", "일상위로", "maro", "마음위로", "자존감", "자기계발", "루틴"],
            "structure": {
                "intro": "10-15초 - 채널 로고 + '오늘의 위로' 타이틀 + 주제 소개",
                "main_message": "120-130초 - 이어지는 위로 글귀 낭독 (6-8개 단락)",
                "outro": "20-30초 - 요약 + '당신은 혼자가 아닙니다' + 다음 영상 안내"
            },
            "timing": {
                "0:00-0:15": "인트로 - 로고 + 제목 카드 + 주제 소개",
                "0:15-2:25": "본문 위로글 - 6-8개 단락으로 이어지는 글귀 낭독",
                "2:25-3:00": "아웃로 - 요약 + 구독/다음 영상 안내"
            }
        }
